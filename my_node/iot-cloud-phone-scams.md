
# 物联网云中的“电话诈骗”

## 主要使用场景


## 物联网云中的认证

现在的物联网云都包含3大部分：

1. 云平台
2. 设备
3. 用户

用户要通过云平台去操作一个设备，首先必须在云平台中建立用户与设备的关联关系（或绑定、认证等）。

这一关系的建立过程如果不严谨，就会出现各种各样的流程漏洞。


## “电话诈骗”漏洞

所谓的电话诈骗，就如：

某天，爸爸接到一个陌生电话，电话里头的人声称是儿子的同事，并报上了儿子的身份证号、工作单位、年龄等一系列个人信息，而且都对了。

不谨慎的爸爸很可能就相信了，然后陌生电话里的人就可以为所欲为了。

电话诈骗之所以会成功，就是因为爸爸不够谨慎。

谨慎的爸爸应该在听到儿子信息之后，则会询问陌生人自己的个人信息，这时候几乎诈骗份子都会挂掉电话的。

而可能任然有部分心存侥幸的人会继续报上信息，爸爸听到后，当然是不能确认信息的真伪的，这时则请这个陌生电话等等，同时给自己的儿子打电话，让儿子进行确认。

到这个时候诈骗份子必定原形毕露。


## 云平台中的漏洞

每个云平台都会有自己的认证机制。
这里列举最近发现的一种。

这个云平台的认证过程是这样的：

1. 用户向设备发送配置网络命令（用户和设备直接通讯）；
2. 设备链接上网络后返回用户一个 SN 码（唯一且每次一样）；
3. 用户再次向设备发送授权命令并附带上 SN 码（用户和设备任然直接通讯）；
4. 设备随后返回用户一个 openId（**唯一且每次一样**）；
5. 用户向云平台发送 openId 建立控制关系；
6. 用户向云平台发送控制命令远程控制设备（不需要再走1-4步骤）。

在这里，假如用户是陌生电话里的人，云平台是爸爸，设备是儿子，openId 是儿子的身份证号、工作单位、年龄等一系列的个人信息。

那么这里的认证过程与上面“电话诈骗”的情景就是一模一样的了。

这个时候，云平台就是一个不谨慎的爸爸了，很容易上当受骗。


## 修补漏洞

云平台只要学习一下谨慎的爸爸那样对用户的信息进行验证确认，就可以防止上当受骗。

以下是两种方案

方案一：

* 1至4步骤同上，只是在第5步时，用户在向云平台发送 openId 的同时附带上自己的验证信息（随机码），而于次同时向设备发送该验证信息；
* 设备收到验证信息后，将该信息转发给云平台；
* 最后云平台收到用户发送的信息后，拿出验证信息与设备发送过来的信息进行比对，一致的则建立控制关系，至此认证结束。

方案二：

* 在第3步骤后，新增一步骤：设备向云平台请求一个校验信息（由云平台生成，并且随机），并在原第4步骤中将此校验信息一并发送给用户；
* 用户随后再向云平台发送 openId 以及此校验信息；
* 最后云平台收到校验信息并与之前生成的进行比对，一致的则建立控制关系，结束认证过程。否则认证失败


## 最后之根本

其实要防止“电话诈骗”漏洞，就必须在3方（云平台、设备、用户）之间建立一个通讯环。
3方之间可以相互通信，让校验信息在这个环内进行流转并比对，建立信任关系。

此后，不管环中那个通讯链断了，它们之间任然可以正常地通讯。



我们在设计绑定与解绑时遇到以下两个问题，想请教一下美的各位同仁有没有更好的解决办法。


* 硬解绑：

用户按下硬解绑按钮后，MCU 通知 wifi 模块清除相关信息。

问题：
在无网络连通情况下执行硬解绑，解绑信息不能上报到云服务器，服务器上仍有用户的绑定信息。若再对设备进行配网，需要设备通知云服务器先进行解绑，再进行绑定。
那么，必须要求设备有存储“设备曾经硬解绑”这一信息。
这个是否可以由 WIFI 模块提供支持？或有其他方案？


* 绑定设备：

流程如下：

1. 用户向设备发送配置网络命令（App和设备直接通讯）；
2. 设备连上网络后返回用户一个 SN 码（唯一且每次一样）；
3. 用户再次向设备发送授权命令并附带上 SN 码（App和设备直接通讯）；
4. 设备随后返回用户一个 openId（**唯一且每次一样**）；
5. 用户向云服务器发送绑定命令（附带参数 openId），云服务器根据发送过来的用户凭证和 openId 建立绑定关系；
6. 绑定流程结束。

问题：
假如云服务器是爸爸，设备是儿子，某用户是某电话号码，openId 是儿子的身份证号、工作单位、年龄等一系列的个人信息。
则，爸爸应该如何防止“电话诈骗”：某天爸爸接到某个电话号码的电话，并声称是儿子的同事，报上了儿子的个人信息......
这个绑定流程是否可再完善？或有其他方案？



